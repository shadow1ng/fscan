name: æµ‹è¯•æž„å»º

on:
  push:
    branches:
      - dev
      - develop
      - feature/*
  pull_request:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:
    inputs:
      branch:
        description: 'æµ‹è¯•åˆ†æ”¯'
        required: false
        default: 'dev'

permissions:
  contents: read

jobs:
  test-build:
    name: æµ‹è¯•æž„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # è®¾ç½®ä½œä¸šçº§åˆ«çš„çŽ¯å¢ƒå˜é‡
    env:
      GITHUB_OWNER: ${{ github.repository_owner }}
      GITHUB_REPO: ${{ github.event.repository.name }}
      PROJECT_NAME: ${{ github.event.repository.name }}

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: ðŸ” èŽ·å–é¡¹ç›®ä¿¡æ¯
        id: project
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "build_time=$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "build_timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ðŸ¹ è®¾ç½® Go çŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.20'
          cache: true

      - name: ðŸ“¦ ä¸‹è½½ä¾èµ–
        run: |
          go mod download
          go mod verify

      - name: ðŸ—œï¸ å®‰è£… UPX åŽ‹ç¼©å·¥å…·
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: â„¹ï¸ æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
        run: |
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "UPX ç‰ˆæœ¬: $(upx --version)"
          echo "åˆ†æ”¯: ${{ steps.project.outputs.branch }}"
          echo "æäº¤: ${{ steps.project.outputs.short_sha }}"
          echo "ä»“åº“: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}"

      - name: ðŸ” éªŒè¯ GoReleaser é…ç½®
        id: config_check
        run: |
          if docker run --rm -v "$(pwd):/workspace" -w /workspace \
            -e GITHUB_REPO="${{ github.event.repository.name }}" \
            -e GITHUB_OWNER="${{ github.repository_owner }}" \
            -e PROJECT_NAME="${{ github.event.repository.name }}" \
            goreleaser/goreleaser:v2-pro check -f .github/conf/.goreleaser.yml; then
            echo "config_valid=true" >> $GITHUB_OUTPUT
          else
            echo "config_valid=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ðŸš€ æµ‹è¯•æž„å»º (Snapshot æ¨¡å¼)
        id: build_step
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'  # ä¿®å¤ï¼šæŒ‡å®šä½¿ç”¨ v2 ç‰ˆæœ¬
          args: release --snapshot --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          PROJECT_NAME: ${{ github.event.repository.name }}
        continue-on-error: true

      - name: ðŸ“‹ ä¸Šä¼ æµ‹è¯•äº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: æµ‹è¯•æž„å»º-${{ steps.project.outputs.branch }}-${{ steps.project.outputs.short_sha }}
          path: |
            dist/
          retention-days: 7
        continue-on-error: true

      - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        if: always()
        run: |
          # è®¡ç®—æž„å»ºæ—¶é—´
          build_end_time=$(date +%s)
          build_duration=$((build_end_time - ${{ steps.project.outputs.build_timestamp }}))
          build_duration_formatted=$(printf "%02d:%02d" $((build_duration / 60)) $((build_duration % 60)))
          
          # æž„å»ºçŠ¶æ€
          if [[ "${{ steps.build_step.outcome }}" == "success" ]]; then
            build_status="![æž„å»ºçŠ¶æ€](https://img.shields.io/badge/æž„å»º-æˆåŠŸ-brightgreen)"
          else
            build_status="![æž„å»ºçŠ¶æ€](https://img.shields.io/badge/æž„å»º-å¤±è´¥-red)"
          fi
          
          echo "# ðŸŽ¯ æž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$build_status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬ä¿¡æ¯
          echo "## ðŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | ä¿¡æ¯ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ **ä»“åº“** | ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ **åˆ†æ”¯** | \`${{ steps.project.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ **æäº¤** | \`${{ steps.project.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| â° **æž„å»ºæ—¶é—´** | ${{ steps.project.outputs.build_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ **æž„å»ºè€—æ—¶** | ${build_duration_formatted} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¹ **Go ç‰ˆæœ¬** | $(go version | cut -d' ' -f3) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºç»“æžœ
          echo "## ðŸš€ æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.config_check.outputs.config_valid }}" == "true" ]]; then
            config_status="âœ… é…ç½®æœ‰æ•ˆ"
          else
            config_status="âŒ é…ç½®æ— æ•ˆ"
          fi
          
          echo "| æž„å»ºé˜¶æ®µ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” **é…ç½®éªŒè¯** | $config_status |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.build_step.outcome }}" == "success" ]]; then
            echo "| ðŸ—ï¸ **å¿«ç…§æž„å»º** | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ—ï¸ **å¿«ç…§æž„å»º** | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºäº§ç‰©
          if [ -d "dist" ]; then
            echo "## ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            total_size=$(du -sh dist/ | cut -f1)
            file_count=$(find dist/ -type f | wc -l)
          
            echo "- ðŸ“ æ€»æ–‡ä»¶æ•°: $file_count" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ æ€»å¤§å°: $total_size" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“‹ è¯¦ç»†æ–‡ä»¶åˆ—è¡¨</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find dist/ -type f -exec ls -lah {} \; | sort >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ€»ç»“
          echo "## ðŸ“‹ æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.build_step.outcome }}" == "success" ]]; then
            echo "ðŸŽ‰ **æž„å»ºæˆåŠŸï¼** æž„å»ºäº§ç‰©å·²ç”Ÿæˆå¹¶å¯ä¾›ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æž„å»ºå¤±è´¥ï¼** è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŽŸå› ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Ž **äº§ç‰©ä¸‹è½½:** æž„å»ºäº§ç‰©å·²ä¸Šä¼ ä¸º Artifactï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **æäº¤é“¾æŽ¥:** https://github.com/${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}/commit/${{ steps.project.outputs.full_sha }}" >> $GITHUB_STEP_SUMMARY