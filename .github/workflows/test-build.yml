name: æµ‹è¯•æ„å»º

on:
  push:
    branches:
      - dev
      - develop
      - feature/*
  pull_request:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:
    inputs:
      branch:
        description: 'æµ‹è¯•åˆ†æ”¯'
        required: false
        default: 'dev'
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  test-build:
    name: æµ‹è¯•æ„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: ğŸ” è·å–é¡¹ç›®ä¿¡æ¯
        id: project
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

      - name: ğŸ¹ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ“¦ ä¸‹è½½ä¾èµ–
        run: |
          go mod download
          go mod verify

      - name: ğŸ—œï¸ å®‰è£… UPX å‹ç¼©å·¥å…·
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: â„¹ï¸ æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "UPX ç‰ˆæœ¬: $(upx --version)"
          echo "åˆ†æ”¯: ${{ steps.project.outputs.branch }}"
          echo "æäº¤: ${{ steps.project.outputs.short_sha }}"
          echo "ä»“åº“: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}"

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        if: ${{ !inputs.skip_tests }}
        run: |
          go test -v ./...

      - name: ğŸ” éªŒè¯ GoReleaser é…ç½®
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: check -f .github/conf/.goreleaser.yml

      - name: ğŸš€ æµ‹è¯•æ„å»º (Snapshot æ¨¡å¼)
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ steps.project.outputs.owner }}
          GITHUB_REPO: ${{ steps.project.outputs.repo }}
          PROJECT_NAME: ${{ steps.project.outputs.repo }}

      - name: ğŸ“‹ ä¸Šä¼ æµ‹è¯•äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: æµ‹è¯•æ„å»º-${{ steps.project.outputs.branch }}-${{ steps.project.outputs.short_sha }}
          path: |
            dist/
          retention-days: 7

      - name: ğŸ§ª æµ‹è¯•ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          echo "## ğŸ§ª æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for binary in dist/*linux*amd64*; do
            if [[ -f "$binary" && -x "$binary" ]]; then
              echo "æµ‹è¯•æ–‡ä»¶: $binary"
              file_info=$(file "$binary")
              echo "- **æ–‡ä»¶ä¿¡æ¯**: $file_info" >> $GITHUB_STEP_SUMMARY
          
              # æµ‹è¯•è¿è¡Œ
              if timeout 10s "$binary" --help > /dev/null 2>&1; then
                echo "- **è¿è¡Œæµ‹è¯•**: âœ… é€šè¿‡" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **è¿è¡Œæµ‹è¯•**: âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              fi
              break
            fi
          done

      - name: ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸ¯ æµ‹è¯•æ„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ steps.project.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ steps.project.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist" ]; then
            echo "### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -la dist/ | head -20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
            echo "### ğŸ“ æ–‡ä»¶å¤§å°ç»Ÿè®¡:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            du -h dist/* | sort -h | tail -10 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # å¯é€‰ï¼šä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¹ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ” ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          if [ "$(gofmt -l . | wc -l)" -gt 0 ]; then
            echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†"
            gofmt -l .
            exit 1
          fi
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

      - name: ğŸ§¹ ä»£ç é™æ€åˆ†æ
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

      - name: ğŸ”’ å®‰å…¨æ£€æŸ¥
        run: |
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          gosec ./...
        continue-on-error: true