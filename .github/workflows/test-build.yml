name: å‘å¸ƒæ„å»º

on:
  push:
    tags:
      - 'v*'  # åªå“åº”ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'å‘å¸ƒæ ‡ç­¾'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  goreleaser:
    name: æ„å»ºå’Œå‘å¸ƒ
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” è·å–é¡¹ç›®ä¿¡æ¯
        id: project
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ¹ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'  # ä½¿ç”¨æ›´æ–°çš„ Go ç‰ˆæœ¬
          cache: true  # å¯ç”¨ Go æ¨¡å—ç¼“å­˜

      - name: ğŸ“¦ ä¸‹è½½ä¾èµ–
        run: |
          go mod download
          go mod verify

      - name: ğŸ—œï¸ å®‰è£… UPX å‹ç¼©å·¥å…·
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: â„¹ï¸ æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "UPX ç‰ˆæœ¬: $(upx --version)"
          echo "Git æ ‡ç­¾: ${{ steps.project.outputs.version }}"
          echo "ä»“åº“: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}"

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          go test -v ./...

      - name: ğŸ” éªŒè¯ GoReleaser é…ç½®
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: check -f .github/conf/.goreleaser.yml

      - name: ğŸš€ æ„å»ºå’Œå‘å¸ƒ
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ steps.project.outputs.owner }}
          GITHUB_REPO: ${{ steps.project.outputs.repo }}
          PROJECT_NAME: ${{ steps.project.outputs.repo }}

      - name: ğŸ“‹ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: æ„å»ºäº§ç‰©-${{ steps.project.outputs.version }}
          path: |
            dist/
            !dist/*.txt
          retention-days: 30

      - name: ğŸ“Š ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸ‰ æ„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.project.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Go ç‰ˆæœ¬**: $(go version | cut -d' ' -f3)" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist" ]; then
            echo "### ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -la dist/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # å¯é€‰ï¼šå‘å¸ƒåˆ° Docker Hub
  docker:
    name: æ„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: goreleaser
    if: success()

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” è·å–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ github.repository }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸš€ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # å¯é€‰ï¼šé€šçŸ¥æ­¥éª¤
  notify:
    name: å‘é€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [goreleaser]
    if: always()

    steps:
      - name: ğŸ“§ å‘é€æˆåŠŸé€šçŸ¥
        if: needs.goreleaser.result == 'success'
        run: |
          echo "âœ… å‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "ç‰ˆæœ¬: ${GITHUB_REF#refs/tags/}"
          echo "æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases"

      - name: âš ï¸ å‘é€å¤±è´¥é€šçŸ¥
        if: needs.goreleaser.result == 'failure'
        run: |
          echo "âŒ å‘å¸ƒå¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"