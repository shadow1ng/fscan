name: æµ‹è¯•æž„å»º

on:
  push:
    branches:
      - dev
      - develop
      - feature/*
  pull_request:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:
    inputs:
      branch:
        description: 'æµ‹è¯•åˆ†æ”¯'
        required: false
        default: 'dev'

permissions:
  contents: read

jobs:
  test-build:
    name: æµ‹è¯•æž„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # è®¾ç½®ä½œä¸šçº§åˆ«çš„çŽ¯å¢ƒå˜é‡
    env:
      GITHUB_OWNER: ${{ github.repository_owner }}
      GITHUB_REPO: ${{ github.event.repository.name }}
      PROJECT_NAME: ${{ github.event.repository.name }}

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: ðŸ” èŽ·å–é¡¹ç›®ä¿¡æ¯
        id: project
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ðŸ¹ è®¾ç½® Go çŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: ðŸ“¦ ä¸‹è½½ä¾èµ–
        run: |
          go mod download
          go mod verify

      - name: ðŸ—œï¸ å®‰è£… UPX åŽ‹ç¼©å·¥å…·
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: â„¹ï¸ æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
        run: |
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "UPX ç‰ˆæœ¬: $(upx --version)"
          echo "åˆ†æ”¯: ${{ steps.project.outputs.branch }}"
          echo "æäº¤: ${{ steps.project.outputs.short_sha }}"
          echo "ä»“åº“: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}"
          echo "æž„å»ºæ—¶é—´: ${{ steps.project.outputs.build_date }}"
          echo "çŽ¯å¢ƒå˜é‡:"
          echo "- GITHUB_OWNER: $GITHUB_OWNER"
          echo "- GITHUB_REPO: $GITHUB_REPO"
          echo "- PROJECT_NAME: $PROJECT_NAME"

      - name: ðŸ“Š è®°å½•æž„å»ºå¼€å§‹æ—¶é—´
        id: build_start
        run: |
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "start_readable=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT

      - name: ðŸš€ æµ‹è¯•æž„å»º (Snapshot æ¨¡å¼)
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š è®°å½•æž„å»ºç»“æŸæ—¶é—´
        id: build_end
        run: |
          echo "end_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "end_readable=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
          start_time=${{ steps.build_start.outputs.start_time }}
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "duration=${duration}" >> $GITHUB_OUTPUT
          echo "duration_readable=$(printf '%02d:%02d:%02d' $((duration/3600)) $((duration%3600/60)) $((duration%60)))" >> $GITHUB_OUTPUT

      - name: ðŸ“‹ ä¸Šä¼ æµ‹è¯•äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: æµ‹è¯•æž„å»º-${{ steps.project.outputs.branch }}-${{ steps.project.outputs.short_sha }}
          path: |
            dist/
          retention-days: 7

      - name: ðŸ§ª æµ‹è¯•ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
        id: binary_test
        run: |
          echo "## ðŸ§ª æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          binary_count=0
          tested_count=0
          passed_count=0
          failed_count=0
          
          echo "| æ–‡ä»¶å | æž¶æž„ | å¤§å° | åŽ‹ç¼© | è¿è¡Œæµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|------|----------|" >> $GITHUB_STEP_SUMMARY
          
          for binary in dist/*/*; do
            if [[ -f "$binary" && -x "$binary" ]]; then
              binary_count=$((binary_count + 1))
              filename=$(basename "$binary")
          
              # èŽ·å–æ–‡ä»¶ä¿¡æ¯
              file_info=$(file "$binary")
              size=$(ls -lh "$binary" | awk '{print $5}')
          
              # æ£€æµ‹æž¶æž„
              if [[ "$file_info" == *"x86-64"* ]]; then
                arch="amd64"
              elif [[ "$file_info" == *"ARM"* ]]; then
                arch="arm64"
              elif [[ "$file_info" == *"386"* ]]; then
                arch="386"
              else
                arch="unknown"
              fi
          
              # æ£€æµ‹æ˜¯å¦åŽ‹ç¼©
              if [[ "$file_info" == *"UPX"* ]]; then
                compressed="âœ… UPX"
              else
                compressed="âŒ æœªåŽ‹ç¼©"
              fi
          
              # è¿è¡Œæµ‹è¯•ï¼ˆä»…å¯¹Linux AMD64ç‰ˆæœ¬ï¼‰
              if [[ "$binary" == *"linux"* && "$arch" == "amd64" ]]; then
                tested_count=$((tested_count + 1))
                if timeout 10s "$binary" --help > /dev/null 2>&1; then
                  test_result="âœ… é€šè¿‡"
                  passed_count=$((passed_count + 1))
                else
                  test_result="âŒ å¤±è´¥"
                  failed_count=$((failed_count + 1))
                fi
              else
                test_result="âž– è·³è¿‡"
              fi
          
              echo "| $filename | $arch | $size | $compressed | $test_result |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµ‹è¯•ç»Ÿè®¡**: æ€»è®¡ $binary_count ä¸ªæ–‡ä»¶ï¼Œæµ‹è¯• $tested_count ä¸ªï¼Œé€šè¿‡ $passed_count ä¸ªï¼Œå¤±è´¥ $failed_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          
          # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "binary_count=$binary_count" >> $GITHUB_OUTPUT
          echo "tested_count=$tested_count" >> $GITHUB_OUTPUT
          echo "passed_count=$passed_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT

      - name: ðŸ“Š ç”Ÿæˆè¯¦ç»†æµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          echo "# ðŸŽ¯ æµ‹è¯•æž„å»ºè¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬ä¿¡æ¯è¡¨æ ¼
          echo "## ðŸ“‹ æž„å»ºåŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ **é¡¹ç›®åç§°** | ${{ steps.project.outputs.repo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ **æ‹¥æœ‰è€…** | ${{ steps.project.outputs.owner }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ **åˆ†æ”¯** | ${{ steps.project.outputs.branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ **æäº¤SHA** | \`${{ steps.project.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“… **æž„å»ºæ—¶é—´** | ${{ steps.project.outputs.build_date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ **æž„å»ºè€—æ—¶** | ${{ steps.build_end.outputs.duration_readable }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ **è§¦å‘æ–¹å¼** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ **Goç‰ˆæœ¬** | $(go version | cut -d' ' -f3) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—œï¸ **UPXç‰ˆæœ¬** | $(upx --version | head -1 | cut -d' ' -f2) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºçŽ¯å¢ƒä¿¡æ¯
          echo "## ðŸ–¥ï¸ æž„å»ºçŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŽ¯å¢ƒå˜é‡ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **GITHUB_OWNER** | $GITHUB_OWNER |" >> $GITHUB_STEP_SUMMARY
          echo "| **GITHUB_REPO** | $GITHUB_REPO |" >> $GITHUB_STEP_SUMMARY
          echo "| **PROJECT_NAME** | $PROJECT_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| **RUNNER_OS** | $RUNNER_OS |" >> $GITHUB_STEP_SUMMARY
          echo "| **RUNNER_ARCH** | $RUNNER_ARCH |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºæ—¶é—´ç»Ÿè®¡
          echo "## â° æž„å»ºæ—¶é—´ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | æ—¶é—´ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ **å¼€å§‹æ—¶é—´** | ${{ steps.build_start.outputs.start_readable }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ **ç»“æŸæ—¶é—´** | ${{ steps.build_end.outputs.end_readable }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ **æ€»è€—æ—¶** | ${{ steps.build_end.outputs.duration_readable }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºäº§ç‰©ç»Ÿè®¡
          if [ -d "dist" ]; then
            echo "## ðŸ“¦ æž„å»ºäº§ç‰©è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # æ–‡ä»¶åˆ—è¡¨
            echo "### ðŸ“„ æ–‡ä»¶åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æ–‡ä»¶å | å¤§å° | ä¿®æ”¹æ—¶é—´ | æƒé™ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|----------|------|" >> $GITHUB_STEP_SUMMARY
          
            cd dist
            find . -type f -exec ls -lh {} \; | head -20 | while read line; do
              permissions=$(echo "$line" | awk '{print $1}')
              size=$(echo "$line" | awk '{print $5}')
              date=$(echo "$line" | awk '{print $6" "$7" "$8}')
              filename=$(echo "$line" | awk '{print $NF}')
              echo "| \`$filename\` | $size | $date | \`$permissions\` |" >> $GITHUB_STEP_SUMMARY
            done
            cd ..
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # æ–‡ä»¶å¤§å°ç»Ÿè®¡
            echo "### ðŸ“ æ–‡ä»¶å¤§å°ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æ–‡ä»¶ | å¤§å° | ç±»åž‹ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
            du -h dist/* | sort -h | tail -10 | while read size file; do
              filename=$(basename "$file")
              filetype=$(file "$file" | cut -d':' -f2 | cut -d',' -f1 | xargs)
              echo "| \`$filename\` | **$size** | $filetype |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # ç›®å½•ç»“æž„
            echo "### ðŸ—‚ï¸ ç›®å½•ç»“æž„" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tree dist/ 2>/dev/null || find dist/ -type d | head -20 | sort >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # å¹³å°æ”¯æŒç»Ÿè®¡
            echo "### ðŸŽ¯ å¹³å°æ”¯æŒç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            linux_count=$(find dist/ -name "*linux*" -type f | wc -l)
            windows_count=$(find dist/ -name "*windows*" -type f | wc -l)
            darwin_count=$(find dist/ -name "*darwin*" -type f | wc -l)
            amd64_count=$(find dist/ -name "*amd64*" -type f | wc -l)
            arm64_count=$(find dist/ -name "*arm64*" -type f | wc -l)
          
            echo "| å¹³å°/æž¶æž„ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ§ **Linux** | $linux_count |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸªŸ **Windows** | $windows_count |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ **macOS** | $darwin_count |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ’» **AMD64** | $amd64_count |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“± **ARM64** | $arm64_count |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ€»ç»“
          echo "## ðŸ“ˆ æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ **æž„å»ºçŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŽ‰ **æž„å»ºçŠ¶æ€**: âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "ðŸ“Š **äºŒè¿›åˆ¶æ–‡ä»¶**: ${{ steps.binary_test.outputs.binary_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª **æµ‹è¯•é€šè¿‡**: ${{ steps.binary_test.outputs.passed_count }}/${{ steps.binary_test.outputs.tested_count }}" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **æž„å»ºè€—æ—¶**: ${{ steps.build_end.outputs.duration_readable }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **äº§ç‰©å¤§å°**: $(du -sh dist/ 2>/dev/null | cut -f1 || echo "æœªçŸ¥")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ·»åŠ å¿«é€Ÿé“¾æŽ¥
          echo "## ðŸ”— å¿«é€Ÿé“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ [æŸ¥çœ‹äº§ç‰©åˆ—è¡¨](https://github.com/${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ [ä¸‹è½½äº§ç‰©](https://github.com/${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” [æŸ¥çœ‹æäº¤](https://github.com/${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}/commit/${{ steps.project.outputs.full_sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ¿ [æŸ¥çœ‹åˆ†æ”¯](https://github.com/${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}/tree/${{ steps.project.outputs.branch }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> $GITHUB_STEP_SUMMARY