name: æµ‹è¯•æž„å»º

on:
  push:
    branches:
      - dev
      - develop
      - feature/*
  pull_request:
    branches:
      - main
      - master
      - dev
  workflow_dispatch:
    inputs:
      branch:
        description: 'æµ‹è¯•åˆ†æ”¯'
        required: false
        default: 'dev'
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        type: boolean
        default: false
      enable_benchmark:
        description: 'å¯ç”¨æ€§èƒ½æµ‹è¯•'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  test-build:
    name: æµ‹è¯•æž„å»º
    runs-on: ubuntu-latest
    timeout-minutes: 45

    # è®¾ç½®ä½œä¸šçº§åˆ«çš„çŽ¯å¢ƒå˜é‡
    env:
      GITHUB_OWNER: ${{ github.repository_owner }}
      GITHUB_REPO: ${{ github.event.repository.name }}
      PROJECT_NAME: ${{ github.event.repository.name }}
      BUILD_START_TIME: ${{ github.run_number }}

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: ðŸ” èŽ·å–é¡¹ç›®ä¿¡æ¯
        id: project
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "build_number=${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT
          echo "build_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          
          # èŽ·å–Gitæäº¤ä¿¡æ¯
          echo "commit_message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=format:'%ci')" >> $GITHUB_OUTPUT

      - name: ðŸ¹ è®¾ç½® Go çŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: ðŸ“¦ ä¸‹è½½ä¾èµ–
        run: |
          echo "build_deps_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          go mod download
          go mod verify
          echo "build_deps_end=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: ðŸ—œï¸ å®‰è£… UPX åŽ‹ç¼©å·¥å…·
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: ðŸ”§ å®‰è£…é¢å¤–å·¥å…·
        run: |
          echo "å¼€å§‹å®‰è£…é¢å¤–å·¥å…·..."

          # åˆ›å»ºå·¥å…·ç›®å½•
          mkdir -p $HOME/bin
          export PATH=$HOME/bin:$PATH

          # å®‰è£…gosec - ä½¿ç”¨å¤šç§æ–¹æ³•å°è¯•
          echo "å®‰è£…gosec..."
          if go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest 2>/dev/null; then
            echo "âœ… gosecå®‰è£…æˆåŠŸï¼ˆæ–¹æ³•1ï¼‰"
            echo "gosec_available=true" >> $GITHUB_ENV
          elif curl -sfL https://raw.githubusercontent.com/securecodewarrior/gosec/master/install.sh | sh -s -- -b $HOME/bin 2>/dev/null; then
            echo "âœ… gosecå®‰è£…æˆåŠŸï¼ˆæ–¹æ³•2ï¼‰"
            echo "gosec_available=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ gosecå®‰è£…å¤±è´¥ï¼Œå°†è·³è¿‡gosecæ‰«æ"
            echo "gosec_available=false" >> $GITHUB_ENV
          fi

          # å®‰è£…staticcheck
          echo "å®‰è£…staticcheck..."
          if go install honnef.co/go/tools/cmd/staticcheck@latest; then
            echo "âœ… staticcheckå®‰è£…æˆåŠŸ"
            echo "staticcheck_available=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ staticcheckå®‰è£…å¤±è´¥"
            echo "staticcheck_available=false" >> $GITHUB_ENV
          fi

          # éªŒè¯å®‰è£…
          echo "éªŒè¯å·¥å…·å®‰è£…..."
          if [ "${gosec_available}" = "true" ] && command -v gosec >/dev/null 2>&1; then
            echo "gosecç‰ˆæœ¬: $(gosec --version 2>/dev/null || echo 'unknown')"
          fi

          if [ "${staticcheck_available}" = "true" ] && command -v staticcheck >/dev/null 2>&1; then
            echo "staticcheckç‰ˆæœ¬: $(staticcheck --version 2>/dev/null || echo 'unknown')"
          fi

      - name: â„¹ï¸ æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
        run: |
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "UPX ç‰ˆæœ¬: $(upx --version)"
          echo "åˆ†æ”¯: ${{ steps.project.outputs.branch }}"
          echo "æäº¤: ${{ steps.project.outputs.short_sha }}"
          echo "ä»“åº“: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}"
          echo "çŽ¯å¢ƒå˜é‡:"
          echo "- GITHUB_OWNER: $GITHUB_OWNER"
          echo "- GITHUB_REPO: $GITHUB_REPO"
          echo "- PROJECT_NAME: $PROJECT_NAME"

      - name: ðŸ§ª è¿è¡Œæµ‹è¯•
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "test_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          
          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
          go test -v -coverprofile=coverage.out -covermode=atomic ./... > test_results.txt 2>&1
          
          # ç”Ÿæˆè¦†ç›–çŽ‡HTMLæŠ¥å‘Š
          go tool cover -html=coverage.out -o coverage.html
          
          # èŽ·å–è¦†ç›–çŽ‡ç™¾åˆ†æ¯”
          coverage_percent=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "test_coverage=$coverage_percent" >> $GITHUB_ENV
          
          echo "test_end=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: ðŸƒ è¿è¡Œæ€§èƒ½æµ‹è¯•
        if: ${{ inputs.enable_benchmark }}
        run: |
          echo "benchmark_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          go test -bench=. -benchmem ./... > benchmark_results.txt 2>&1
          echo "benchmark_end=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: ðŸ”’ å®‰å…¨æ‰«æ
        run: |
          echo "security_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          gosec -fmt json -out gosec_results.json ./... || true
          staticcheck ./... > staticcheck_results.txt 2>&1 || true
          echo "security_end=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: ðŸ“Š ä¾èµ–åˆ†æž
        run: |
          # åˆ†æžä¾èµ–ä¿¡æ¯
          go list -m all > dependencies.txt
          go mod why -m all > dependency_why.txt 2>&1 || true
          
          # ç»Ÿè®¡ä¾èµ–æ•°é‡
          dep_count=$(go list -m all | wc -l)
          echo "dependency_count=$dep_count" >> $GITHUB_ENV

      - name: ðŸ” éªŒè¯ GoReleaser é…ç½®
        run: |
          echo "config_check_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          goreleaser check -f .github/conf/.goreleaser.yml
          echo "config_check_end=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: ðŸš€ æµ‹è¯•æž„å»º (Snapshot æ¨¡å¼)
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ ä¸Šä¼ æµ‹è¯•äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: æµ‹è¯•æž„å»º-${{ steps.project.outputs.branch }}-${{ steps.project.outputs.short_sha }}
          path: |
            dist/
            coverage.html
            test_results.txt
            benchmark_results.txt
            gosec_results.json
            staticcheck_results.txt
            dependencies.txt
          retention-days: 7

      - name: ðŸ§ª æµ‹è¯•ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          echo "binary_test_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          
          # åˆ›å»ºæµ‹è¯•ç»“æžœæ–‡ä»¶
          mkdir -p test_reports
          
          echo "## ðŸ§ª äºŒè¿›åˆ¶æ–‡ä»¶æµ‹è¯•ç»“æžœ" > test_reports/binary_test.md
          echo "" >> test_reports/binary_test.md
          
          tested_count=0
          passed_count=0
          
          for binary in dist/*; do
            if [[ -f "$binary" && -x "$binary" ]]; then
              tested_count=$((tested_count + 1))
          
              echo "### æµ‹è¯•æ–‡ä»¶: $(basename "$binary")" >> test_reports/binary_test.md
          
              # èŽ·å–æ–‡ä»¶ä¿¡æ¯
              file_info=$(file "$binary")
              file_size=$(stat -c%s "$binary" | numfmt --to=iec)
          
              echo "- **æ–‡ä»¶è·¯å¾„**: $binary" >> test_reports/binary_test.md
              echo "- **æ–‡ä»¶å¤§å°**: $file_size" >> test_reports/binary_test.md
              echo "- **æ–‡ä»¶ç±»åž‹**: $file_info" >> test_reports/binary_test.md
          
              # è®¡ç®—SHA256
              sha256_hash=$(sha256sum "$binary" | cut -d' ' -f1)
              echo "- **SHA256**: $sha256_hash" >> test_reports/binary_test.md
          
              # æµ‹è¯•è¿è¡Œ
              if timeout 10s "$binary" --help > /dev/null 2>&1; then
                echo "- **è¿è¡Œæµ‹è¯•**: âœ… é€šè¿‡" >> test_reports/binary_test.md
                passed_count=$((passed_count + 1))
              else
                echo "- **è¿è¡Œæµ‹è¯•**: âŒ å¤±è´¥" >> test_reports/binary_test.md
              fi
          
              # æµ‹è¯•ç‰ˆæœ¬ä¿¡æ¯
              if timeout 5s "$binary" --version > version_output.txt 2>&1; then
                version_info=$(cat version_output.txt)
                echo "- **ç‰ˆæœ¬ä¿¡æ¯**: $version_info" >> test_reports/binary_test.md
              else
                echo "- **ç‰ˆæœ¬ä¿¡æ¯**: æ— æ³•èŽ·å–" >> test_reports/binary_test.md
              fi
          
              echo "" >> test_reports/binary_test.md
            fi
          done
          
          echo "binary_tested_count=$tested_count" >> $GITHUB_ENV
          echo "binary_passed_count=$passed_count" >> $GITHUB_ENV
          echo "binary_test_end=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: ðŸ“Š ç”Ÿæˆè¯¦ç»†æµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          echo "report_start=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          
          # è®¡ç®—æž„å»ºæ—¶é—´
          build_end=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # åˆ›å»ºè¯¦ç»†æŠ¥å‘Š
          echo "# ðŸŽ¯ è¯¦ç»†æµ‹è¯•æž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬ä¿¡æ¯éƒ¨åˆ†
          echo "## ðŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **ä»“åº“** | ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **åˆ†æ”¯** | ${{ steps.project.outputs.branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æäº¤** | ${{ steps.project.outputs.short_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æž„å»ºå·** | ${{ steps.project.outputs.build_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æäº¤æ¶ˆæ¯** | ${{ steps.project.outputs.commit_message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æäº¤ä½œè€…** | ${{ steps.project.outputs.commit_author }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æž„å»ºæ—¶é—´** | $build_end |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºçŠ¶æ€éƒ¨åˆ†
          echo "## ðŸ“ˆ æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥å„ä¸ªæ­¥éª¤çš„çŠ¶æ€
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŸ¢ **æ€»ä½“çŠ¶æ€**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" == "failure" ]; then
            echo "ðŸ”´ **æ€»ä½“çŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŸ¡ **æ€»ä½“çŠ¶æ€**: è¿›è¡Œä¸­" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æµ‹è¯•ç»“æžœéƒ¨åˆ†
          if [ "${{ !inputs.skip_tests }}" == "true" ]; then
            echo "## ðŸ§ª æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
            if [ -f "test_results.txt" ]; then
              # ç»Ÿè®¡æµ‹è¯•ç»“æžœ
              total_tests=$(grep -c "=== RUN" test_results.txt || echo "0")
              passed_tests=$(grep -c "--- PASS:" test_results.txt || echo "0")
              failed_tests=$(grep -c "--- FAIL:" test_results.txt || echo "0")
          
              echo "| æŒ‡æ ‡ | å€¼ |" >> $GITHUB_STEP_SUMMARY
              echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
              echo "| **æ€»æµ‹è¯•æ•°** | $total_tests |" >> $GITHUB_STEP_SUMMARY
              echo "| **é€šè¿‡** | $passed_tests |" >> $GITHUB_STEP_SUMMARY
              echo "| **å¤±è´¥** | $failed_tests |" >> $GITHUB_STEP_SUMMARY
              echo "| **è¦†ç›–çŽ‡** | ${test_coverage:-N/A} |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
          
              # å¦‚æžœæœ‰å¤±è´¥çš„æµ‹è¯•ï¼Œæ˜¾ç¤ºè¯¦æƒ…
              if [ "$failed_tests" -gt 0 ]; then
                echo "### âŒ å¤±è´¥çš„æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                grep -A 5 "--- FAIL:" test_results.txt | head -20 >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "## ðŸ§ª æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ **æµ‹è¯•å·²è·³è¿‡**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ€§èƒ½æµ‹è¯•ç»“æžœ
          if [ "${{ inputs.enable_benchmark }}" == "true" ] && [ -f "benchmark_results.txt" ]; then
            echo "## ðŸƒ æ€§èƒ½æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep "Benchmark" benchmark_results.txt | head -10 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å®‰å…¨æ‰«æç»“æžœ
          echo "## ðŸ”’ å®‰å…¨æ‰«æç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
          # GoSecç»“æžœ
          if [ -f "gosec_results.json" ]; then
            issues_count=$(jq '.Issues | length' gosec_results.json 2>/dev/null || echo "0")
            echo "- **GoSecæ‰«æ**: $issues_count ä¸ªé—®é¢˜å‘çŽ°" >> $GITHUB_STEP_SUMMARY
          fi
          
          # StaticCheckç»“æžœ
          if [ -f "staticcheck_results.txt" ]; then
            staticcheck_issues=$(wc -l < staticcheck_results.txt || echo "0")
            echo "- **StaticCheckæ‰«æ**: $staticcheck_issues ä¸ªé—®é¢˜å‘çŽ°" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ä¾èµ–ä¿¡æ¯
          echo "## ðŸ“¦ ä¾èµ–ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¾èµ–æ€»æ•°**: ${dependency_count:-N/A}" >> $GITHUB_STEP_SUMMARY
          echo "- **Goç‰ˆæœ¬**: $(go version | cut -d' ' -f3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # äºŒè¿›åˆ¶æ–‡ä»¶æµ‹è¯•ç»“æžœ
          echo "## ðŸ§ª äºŒè¿›åˆ¶æ–‡ä»¶æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•æ–‡ä»¶æ•°**: ${binary_tested_count:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- **é€šè¿‡æ•°**: ${binary_passed_count:-0}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${binary_tested_count:-0}" -gt 0 ]; then
            success_rate=$((binary_passed_count * 100 / binary_tested_count))
            echo "- **æˆåŠŸçŽ‡**: ${success_rate}%" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºäº§ç‰©ç»Ÿè®¡
          if [ -d "dist" ]; then
            echo "## ðŸ“¦ æž„å»ºäº§ç‰©ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          
            # æ–‡ä»¶æ•°é‡ç»Ÿè®¡
            total_files=$(find dist -type f | wc -l)
            echo "- **æ€»æ–‡ä»¶æ•°**: $total_files" >> $GITHUB_STEP_SUMMARY
          
            # æ€»å¤§å°ç»Ÿè®¡
            total_size=$(du -sh dist/ | cut -f1)
            echo "- **æ€»å¤§å°**: $total_size" >> $GITHUB_STEP_SUMMARY
          
            # æŒ‰ç±»åž‹åˆ†ç±»
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š æ–‡ä»¶ç±»åž‹åˆ†å¸ƒ" >> $GITHUB_STEP_SUMMARY
            echo "| ç±»åž‹ | æ•°é‡ | å¤§å° |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
            # ç»Ÿè®¡ä¸åŒç±»åž‹çš„æ–‡ä»¶
            for ext in "tar.gz" "zip" "deb" "rpm" "apk" ""; do
              if [ -z "$ext" ]; then
                # ç»Ÿè®¡æ— æ‰©å±•åçš„æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
                count=$(find dist -type f -executable | wc -l)
                size=$(find dist -type f -executable -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
                [ "$count" -gt 0 ] && echo "| äºŒè¿›åˆ¶æ–‡ä»¶ | $count | $size |" >> $GITHUB_STEP_SUMMARY
              else
                count=$(find dist -name "*.$ext" | wc -l)
                if [ "$count" -gt 0 ]; then
                  size=$(find dist -name "*.$ext" -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
                  echo "| .$ext | $count | $size |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # æœ€å¤§æ–‡ä»¶Top 5
            echo "### ðŸ“ æœ€å¤§æ–‡ä»¶ Top 5" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find dist -type f -exec du -h {} + | sort -rh | head -5 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # æž¶æž„åˆ†å¸ƒ
            echo "### ðŸ—ï¸ æž¶æž„åˆ†å¸ƒ" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find dist -type f -name "*" | grep -E "(amd64|arm64|386|arm)" | cut -d'_' -f2- | cut -d'.' -f1 | sort | uniq -c | sort -nr >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æž„å»ºæ—¶é—´åˆ†æž
          echo "## â±ï¸ æž„å»ºæ—¶é—´åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | å¼€å§‹æ—¶é—´ | ç»“æŸæ—¶é—´ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ä¾èµ–ä¸‹è½½** | ${build_deps_start:-N/A} | ${build_deps_end:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æµ‹è¯•æ‰§è¡Œ** | ${test_start:-N/A} | ${test_end:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| **å®‰å…¨æ‰«æ** | ${security_start:-N/A} | ${security_end:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| **äºŒè¿›åˆ¶æµ‹è¯•** | ${binary_test_start:-N/A} | ${binary_test_end:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æŠ¥å‘Šç”Ÿæˆ** | ${report_start:-N/A} | $build_end |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # çŽ¯å¢ƒä¿¡æ¯
          echo "## ðŸ”§ çŽ¯å¢ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner OS**: $(uname -s)" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner Architecture**: $(uname -m)" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version**: $(go version)" >> $GITHUB_STEP_SUMMARY
          echo "- **UPX Version**: $(upx --version 2>/dev/null | head -1 || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "- **GoReleaser Version**: $(goreleaser --version 2>/dev/null | head -1 || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ·»åŠ äºŒè¿›åˆ¶æ–‡ä»¶è¯¦ç»†æµ‹è¯•ç»“æžœ
          if [ -f "test_reports/binary_test.md" ]; then
            echo "## ðŸ” äºŒè¿›åˆ¶æ–‡ä»¶è¯¦ç»†æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æµ‹è¯•ç»“æžœ</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat test_reports/binary_test.md >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æž„å»ºå»ºè®®
          echo "## ðŸ’¡ æž„å»ºå»ºè®®" >> $GITHUB_STEP_SUMMARY
          
          # æ ¹æ®æµ‹è¯•ç»“æžœç»™å‡ºå»ºè®®
          if [ "${test_coverage%.*}" -lt 80 ] 2>/dev/null; then
            echo "âš ï¸ å»ºè®®æé«˜æµ‹è¯•è¦†ç›–çŽ‡åˆ°80%ä»¥ä¸Š" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${binary_passed_count:-0}" -lt "${binary_tested_count:-0}" ]; then
            echo "âš ï¸ éƒ¨åˆ†äºŒè¿›åˆ¶æ–‡ä»¶æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æž„å»ºé…ç½®" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${dependency_count:-0}" -gt 50 ]; then
            echo "ðŸ’¡ ä¾èµ–è¾ƒå¤šï¼Œå»ºè®®å®šæœŸå®¡æŸ¥å’Œæ¸…ç†ä¸å¿…è¦çš„ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— æž„å»ºURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Ž ä¸Šä¼ è¯¦ç»†æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: è¯¦ç»†æµ‹è¯•æŠ¥å‘Š-${{ steps.project.outputs.branch }}-${{ steps.project.outputs.short_sha }}
          path: |
            test_reports/
            coverage.html
            test_results.txt
            benchmark_results.txt
            gosec_results.json
            staticcheck_results.txt
            dependencies.txt
            dependency_why.txt
          retention-days: 14