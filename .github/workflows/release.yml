name: å‘å¸ƒæž„å»º

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'å‘å¸ƒæ ‡ç­¾'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  goreleaser:
    name: æž„å»ºå’Œå‘å¸ƒ
    runs-on: ubuntu-latest
    timeout-minutes: 60

    # è®¾ç½®ä½œä¸šçº§åˆ«çš„çŽ¯å¢ƒå˜é‡
    env:
      GITHUB_OWNER: ${{ github.repository_owner }}
      GITHUB_REPO: ${{ github.event.repository.name }}
      PROJECT_NAME: ${{ github.event.repository.name }}

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” èŽ·å–é¡¹ç›®ä¿¡æ¯
        id: project
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ðŸ¹ è®¾ç½® Go çŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: ðŸ“¦ ä¸‹è½½ä¾èµ–
        run: |
          go mod download
          go mod verify

      - name: ðŸ—œï¸ å®‰è£… UPX åŽ‹ç¼©å·¥å…·
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: â„¹ï¸ æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
        run: |
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "UPX ç‰ˆæœ¬: $(upx --version)"
          echo "Git æ ‡ç­¾: ${{ steps.project.outputs.version }}"
          echo "ä»“åº“: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}"

      - name: ðŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          go test -v ./...

      - name: ðŸ” éªŒè¯ GoReleaser é…ç½®
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: check -f .github/conf/.goreleaser.yml

      - name: ðŸš€ æž„å»ºå’Œå‘å¸ƒ
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: æž„å»ºäº§ç‰©-${{ steps.project.outputs.version }}
          path: |
            dist/
            !dist/*.txt
          retention-days: 30

      - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "## ðŸŽ‰ æž„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.project.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ steps.project.outputs.owner }}/${{ steps.project.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Go ç‰ˆæœ¬**: $(go version | cut -d' ' -f3)" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist" ]; then
            echo "### ðŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -la dist/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi