name: å‘å¸ƒæž„å»º

on:
  push:
    tags:
      - 'v*'
    branches:
      - dev  # æ·»åŠ  dev åˆ†æ”¯æ”¯æŒ
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      tag:
        description: 'å‘å¸ƒæ ‡ç­¾'
        required: false
        default: 'v1.0.0'
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ (ä¸ä¼šå‘å¸ƒ)'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  goreleaser:
    name: æž„å»ºå’Œå‘å¸ƒ
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” åˆ¤æ–­è¿è¡Œæ¨¡å¼
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            echo "mode=release" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
            echo "mode=test" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "mode=snapshot" >> $GITHUB_OUTPUT
            echo "version=dev-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          fi
          
          echo "owner=${GITHUB_REPOSITORY_OWNER}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT

      - name: ðŸ¹ è®¾ç½® Go çŽ¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: ðŸ“¦ ä¸‹è½½ä¾èµ–
        run: |
          go mod download
          go mod verify

      - name: ðŸ—œï¸ å®‰è£… UPX åŽ‹ç¼©å·¥å…·
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: â„¹ï¸ æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
        run: |
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "UPX ç‰ˆæœ¬: $(upx --version)"
          echo "è¿è¡Œæ¨¡å¼: ${{ steps.mode.outputs.mode }}"
          echo "ç‰ˆæœ¬: ${{ steps.mode.outputs.version }}"
          echo "ä»“åº“: ${{ steps.mode.outputs.owner }}/${{ steps.mode.outputs.repo }}"

      - name: ðŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          go test -v ./...

      - name: ðŸ” éªŒè¯ GoReleaser é…ç½®
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: check -f .github/conf/.goreleaser.yml

      - name: ðŸš€ æ­£å¼å‘å¸ƒ
        if: steps.mode.outputs.mode == 'release'
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ steps.mode.outputs.owner }}
          GITHUB_REPO: ${{ steps.mode.outputs.repo }}
          PROJECT_NAME: ${{ steps.mode.outputs.repo }}

      - name: ðŸ§ª æµ‹è¯•æž„å»º (Snapshot æ¨¡å¼)
        if: steps.mode.outputs.mode != 'release'
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean -f .github/conf/.goreleaser.yml
          workdir: .
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ steps.mode.outputs.owner }}
          GITHUB_REPO: ${{ steps.mode.outputs.repo }}
          PROJECT_NAME: ${{ steps.mode.outputs.repo }}

      - name: ðŸ“‹ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: |
            ${{ steps.mode.outputs.mode == 'release' && 'æ­£å¼å‘å¸ƒ' || 'æµ‹è¯•æž„å»º' }}-${{ steps.mode.outputs.version }}
          path: |
            dist/
          retention-days: ${{ steps.mode.outputs.mode == 'release' && 90 || 7 }}

      - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        if: always()
        run: |
          mode_emoji="${{ steps.mode.outputs.mode == 'release' && 'ðŸŽ‰' || 'ðŸ§ª' }}"
          echo "## ${mode_emoji} æž„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡å¼**: ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.mode.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ steps.mode.outputs.owner }}/${{ steps.mode.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist" ]; then
            echo "### ðŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -la dist/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi